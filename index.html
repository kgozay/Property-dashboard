<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conservative SA Property Underwriter</title>
    <style>
        :root {
            --primary: #1a2a3a; /* Deep Navy - Professional/Conservative */
            --secondary: #34495e;
            --accent: #27ae60;  /* Green for positive cashflow */
            --danger: #c0392b;  /* Red for negative/risk */
            --warning: #f39c12;
            --light: #f8f9fa;
            --border: #dee2e6;
            --surface: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
        header .badge {
            background-color: rgba(255,255,255,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr; }
        }

        /* Sidebar Inputs */
        .sidebar {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: fit-content;
        }

        h2 { font-size: 1.1rem; color: var(--secondary); border-bottom: 2px solid var(--light); padding-bottom: 10px; margin-top: 0; }
        
        .section { margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        /* Updated input styles for text type */
        input[type="number"], input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
            font-family: monospace; /* Helps alignment for numbers */
        }
        input:focus { outline: none; border-color: var(--primary); }

        .hint { font-size: 0.75rem; color: #888; margin-top: 3px; }

        /* Main Dashboard */
        .dashboard {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: min-content;
        }

        /* KPI Cards */
        .card {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .card.hero {
            background: var(--primary);
            color: white;
            grid-column: span 1;
        }
        .card.hero .metric-label { color: rgba(255,255,255,0.7); }
        .card.hero .metric-value { color: white; }
        
        .metric-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #777; margin-bottom: 5px; }
        .metric-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .metric-sub { font-size: 0.85rem; margin-top: 5px; font-weight: 500; }
        
        .positive { color: var(--accent) !important; }
        .negative { color: var(--danger) !important; }

        /* Full Width Sections */
        .full-width { grid-column: 1 / -1; }

        /* Tables */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .analysis-table td, .analysis-table th { padding: 8px 0; border-bottom: 1px solid #eee; }
        .analysis-table th { text-align: right; color: #777; font-weight: 600; font-size: 0.8rem; padding-bottom: 10px; }
        .analysis-table th:first-child { text-align: left; }
        .analysis-table tr:last-child td { border-bottom: none; }
        
        .analysis-table .row-label { color: #555; }
        .analysis-table .row-value { text-align: right; font-weight: 600; font-family: monospace; font-size: 1rem; }
        .analysis-table .indent { padding-left: 20px; font-size: 0.85rem; color: #777; }
        .analysis-table .total-row td { border-top: 2px solid var(--border); border-bottom: none; padding-top: 12px; font-weight: 700; font-size: 1rem; }
        
        /* Stress Test Panel */
        .stress-panel {
            background-color: #fff5f5;
            border: 1px solid #ffebeb;
        }
        .stress-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stress-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--danger);
        }
        .stress-item h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--danger); }
        .stress-item .result { font-weight: 700; font-size: 1.1rem; }
        .stress-item .desc { font-size: 0.75rem; color: #666; margin-top: 5px; }

        /* Cash Stack */
        .cash-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .cash-item {
            flex: 1;
            min-width: 120px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid var(--secondary);
        }
        .cash-item small { display: block; font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .cash-item span { display: block; font-size: 1rem; font-weight: 700; color: #333; margin-top: 3px; }

        @media (max-width: 1024px) {
            .dashboard { grid-template-columns: repeat(2, 1fr); }
            .table-card { grid-column: 1 / -1 !important; }
        }
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .stress-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Conservative Underwriter Pro</h1>
        <div style="font-size: 0.8rem; opacity: 0.8; margin-top:2px;">South Africa Edition | 2025 Tax Tables</div>
    </div>
    <div class="badge">ZAR Model</div>
</header>

<div class="container">
    <!-- SIDEBAR INPUTS -->
    <div class="sidebar">
        <div class="section">
            <h2>1. Acquisition</h2>
            <div class="input-group">
                <label>Purchase Price (ZAR)</label>
                <!-- Changed to text input for formatting -->
                <input type="text" id="purchasePrice" value="1,650,000" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
            </div>
            <div class="input-group">
                <label>Renovation Budget (CapEx)</label>
                <input type="text" id="capex" value="50,000" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
                <div class="hint">Paint, carpets, immediate fixes</div>
            </div>
            <div class="input-group">
                <label>Bond & Transfer Fees</label>
                <input type="text" id="legalCosts" value="55,000" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
                <div class="hint">Attorneys, deeds office (Est. ~3-4%)</div>
            </div>
        </div>

        <div class="section">
            <h2>2. Financing</h2>
            <div class="input-group">
                <label>Deposit Amount</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="depositPercent" value="10" style="width: 70px;" oninput="updateDeposit('percent')">
                    <span style="padding-top:8px;">% OR R</span>
                    <input type="text" id="depositAmount" value="165,000" oninput="updateDeposit('amount')" onfocus="cleanInput(this)" onblur="formatInput(this)">
                </div>
            </div>
            <div class="input-group">
                <label>Interest Rate (%)</label>
                <!-- Keeping rates as number type -->
                <input type="number" id="interestRate" value="11.25" step="0.25" oninput="calculate()">
                <div class="hint">Current Prime is 10.25%. Use 11.25% for conservative buffer.</div>
            </div>
            <div class="input-group">
                <label>Loan Term (Years)</label>
                <select id="loanTerm" onchange="calculate()">
                    <option value="20" selected>20 Years</option>
                    <option value="30">30 Years</option>
                    <option value="10">10 Years</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h2>3. Income & Expenses</h2>
            <div class="input-group">
                <label>Gross Monthly Rent</label>
                <input type="text" id="rent" value="15,500" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
            </div>
            <div class="input-group">
                <label>Rates & Taxes (Municipal)</label>
                <input type="text" id="rates" value="950" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
            </div>
            <div class="input-group">
                <label>Levies (Body Corp / HOA)</label>
                <input type="text" id="levies" value="1,800" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
            </div>
            <div class="input-group">
                <label>Other Monthly Costs</label>
                <input type="text" id="otherCost" value="0" oninput="calculate()" onfocus="cleanInput(this)" onblur="formatInput(this)">
                <div class="hint">WiFi, Insurance, Staff, etc.</div>
            </div>
        </div>

        <div class="section">
            <h2>4. Conservative Assumptions</h2>
            <div class="input-group">
                <label>Vacancy Allowance (%)</label>
                <input type="number" id="vacancy" value="8.33" step="1" oninput="calculate()">
                <div class="hint">8.33% = 1 month empty per year</div>
            </div>
            <div class="input-group">
                <label>Maintenance Reserve (%)</label>
                <input type="number" id="maintenance" value="10" step="1" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>Management Fee (%)</label>
                <input type="number" id="management" value="10" step="1" oninput="calculate()">
                <div class="hint">Excl VAT (Typically 8-12%)</div>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard">
        
        <!-- Top Metrics -->
        <div class="card hero">
            <div class="metric-label">Net Monthly Cashflow</div>
            <div class="metric-value" id="dispCashflow">R 0</div>
            <div class="metric-sub" id="dispCashflowSub">After all expenses & debt</div>
        </div>
        
        <div class="card">
            <div class="metric-label">Cash-on-Cash Return</div>
            <div class="metric-value" id="dispCoC">0.0%</div>
            <div class="metric-sub">Yield on actual cash invested</div>
        </div>

        <div class="card">
            <div class="metric-label">Cap Rate</div>
            <div class="metric-value" id="dispCap">0.0%</div>
            <div class="metric-sub">Unleveraged Return</div>
        </div>

        <!-- NEW CARD: Break Even Rent -->
        <div class="card" style="border-top: 3px solid var(--warning);">
            <div class="metric-label">Break-Even Rent</div>
            <div class="metric-value" id="dispBreakEvenRent">R 0</div>
            <div class="metric-sub">Min rent to cover all costs</div>
        </div>

        <!-- Cash Required Breakdown -->
        <div class="card full-width">
            <div class="metric-label">Total Cash Required Upfront</div>
            <div class="cash-stack">
                <div class="cash-item">
                    <small>Deposit</small>
                    <span id="dispDeposit">R 0</span>
                </div>
                <div class="cash-item">
                    <small>Transfer Duty (2025)</small>
                    <span id="dispTransferDuty">R 0</span>
                </div>
                <div class="cash-item">
                    <small>Bond/Legal Fees</small>
                    <span id="dispLegal">R 0</span>
                </div>
                <div class="cash-item">
                    <small>Renovation</small>
                    <span id="dispCapex">R 0</span>
                </div>
                <div class="cash-item" style="background: var(--primary); color: white; border: none;">
                    <small style="color: #ccc;">Check to Write</small>
                    <span id="dispTotalCash" style="color: white;">R 0</span>
                </div>
            </div>
        </div>

        <!-- Income Statement (Span 3 for more room) -->
        <div class="card full-width table-card" style="grid-column: span 3;">
            <div class="metric-label" style="margin-bottom: 15px;">Monthly Operating Statement</div>
            <table class="analysis-table">
                <tr>
                    <td class="row-label">Gross Scheduled Rent</td>
                    <td class="row-value" id="tblGrossRent">R 0</td>
                </tr>
                <tr>
                    <td class="indent">Less: Vacancy Allowance (<span id="txtVacancy">0</span>%)</td>
                    <td class="row-value negative" id="tblVacancy">- R 0</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td class="row-label"><strong>Effective Gross Income</strong></td>
                    <td class="row-value" id="tblEGI"><strong>R 0</strong></td>
                </tr>
                <tr><td colspan="2" style="height:10px;"></td></tr>
                <tr>
                    <td class="row-label">Rates & Taxes</td>
                    <td class="row-value negative" id="tblRates">- R 0</td>
                </tr>
                <tr>
                    <td class="row-label">Levies (Sectional Title)</td>
                    <td class="row-value negative" id="tblLevies">- R 0</td>
                </tr>
                <tr>
                    <td class="indent">Management Fees (<span id="txtMgmt">0</span>%)</td>
                    <td class="row-value negative" id="tblMgmt">- R 0</td>
                </tr>
                <tr>
                    <td class="indent">Maintenance Reserve (<span id="txtMaint">0</span>%)</td>
                    <td class="row-value negative" id="tblMaint">- R 0</td>
                </tr>
                <tr>
                    <td class="indent">Other Costs</td>
                    <td class="row-value negative" id="tblOther">- R 0</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td class="row-label"><strong>Net Operating Income (NOI)</strong></td>
                    <td class="row-value" id="tblNOI"><strong>R 0</strong></td>
                </tr>
                <tr><td colspan="2" style="height:10px;"></td></tr>
                <tr>
                    <td class="row-label">Debt Service (Bond Repayment)</td>
                    <td class="row-value negative" id="tblBond">- R 0</td>
                </tr>
                <tr class="total-row">
                    <td>Net Cash Flow</td>
                    <td class="row-value" id="tblCashflow">R 0</td>
                </tr>
            </table>
        </div>

        <!-- 50% Rule & Ratios -->
        <div class="card">
            <div class="metric-label">Quick Ratios</div>
            <div style="margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <span style="font-size:0.9rem;">Expense Ratio</span>
                    <strong id="dispExpRatio">0%</strong>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <span style="font-size:0.9rem;">Gross Yield</span>
                    <strong id="dispGrossYield">0%</strong>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <span style="font-size:0.9rem;">1% Rule Met?</span>
                    <strong id="disp1Rule">No</strong>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 4px; font-size: 0.8rem; color: #555;">
                    <strong>Conservative Note:</strong> A healthy Expense Ratio in SA is typically 40-50% including vacancies and reserves.
                </div>
            </div>
        </div>

        <!-- Stress Test -->
        <div class="card full-width stress-panel">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.5rem;">⚠️</span>
                <div>
                    <div class="metric-label" style="color:var(--danger); font-weight:700;">Analyst Stress Test</div>
                    <div class="metric-sub" style="margin-top:0;">What happens if the market turns?</div>
                </div>
            </div>

            <div class="stress-grid">
                <div class="stress-item">
                    <h4>Interest Rate Shock</h4>
                    <div class="result" id="stressRateRes">R 0</div>
                    <div class="desc">If Prime goes up by 200bps (+2%)</div>
                </div>
                <div class="stress-item">
                    <h4>Vacancy Crisis</h4>
                    <div class="result" id="stressVacRes">R 0</div>
                    <div class="desc">If Vacancy hits 16.6% (2 months)</div>
                </div>
                <div class="stress-item">
                    <h4>Breakeven Point</h4>
                    <div class="result" id="stressBreakRes">0%</div>
                    <div class="desc">Occupancy needed to cover all costs</div>
                </div>
            </div>
        </div>

        <!-- Annual Summary -->
        <div class="card full-width" style="background: #fdfdfd; border-top: 3px solid var(--primary);">
            <div class="metric-label" style="color: var(--primary);">Annualized Financial Summary</div>
            <table class="analysis-table" style="margin-top:10px;">
                <thead>
                    <tr>
                        <th style="text-align:left;">Item</th>
                        <th>Monthly</th>
                        <th>Annual</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Gross Income</td>
                        <td class="row-value" id="sumGrossM">R 0</td>
                        <td class="row-value" id="sumGrossA">R 0</td>
                    </tr>
                    <tr>
                        <td class="row-label">Total Expenses</td>
                        <td class="row-value negative" id="sumExpM">- R 0</td>
                        <td class="row-value negative" id="sumExpA">- R 0</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td class="row-label"><strong>Net Operating Income</strong></td>
                        <td class="row-value" id="sumNoiM">R 0</td>
                        <td class="row-value" id="sumNoiA">R 0</td>
                    </tr>
                    <tr>
                        <td class="row-label">Annual Debt Service</td>
                        <td class="row-value negative" id="sumDebtM">- R 0</td>
                        <td class="row-value negative" id="sumDebtA">- R 0</td>
                    </tr>
                    <tr class="total-row">
                        <td>Net Cash Flow</td>
                        <td class="row-value" id="sumFlowM">R 0</td>
                        <td class="row-value" id="sumFlowA">R 0</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    // --- UTILS FOR INPUT FORMATTING ---
    function cleanInput(el) {
        // Remove commas when user clicks in to edit
        el.value = el.value.replace(/,/g, '');
    }

    function formatInput(el) {
        // Add commas when user clicks out
        const val = parseFloat(el.value.replace(/,/g, ''));
        if (!isNaN(val)) {
            el.value = new Intl.NumberFormat('en-US').format(val);
        }
    }

    function parseVal(id) {
        // Helper to get raw float value from input ID
        const val = document.getElementById(id).value;
        return parseFloat(val.replace(/,/g, '')) || 0;
    }

    // Constants for 2025 Transfer Duty Calculation
    function calculateTransferDuty(price) {
        if (price <= 1210000) return 0;
        if (price <= 1663800) return (price - 1210000) * 0.03;
        if (price <= 2329300) return 13614 + (price - 1663800) * 0.06;
        if (price <= 2994800) return 53544 + (price - 2329300) * 0.08;
        if (price <= 13310000) return 106784 + (price - 2994800) * 0.11;
        return 1241456 + (price - 13310000) * 0.13;
    }

    function PMT(rate, nper, pv) {
        let r = rate / 1200;
        let n = nper * 12;
        if (r === 0) return pv / n;
        return (pv * r * Math.pow((1 + r), n)) / (Math.pow((1 + r), n) - 1);
    }

    function formatCurrency(num) {
        return "R " + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
    }

    function formatPercent(num) {
        return num.toFixed(2) + '%';
    }

    function updateDeposit(source) {
        const price = parseVal('purchasePrice');
        if (source === 'percent') {
            const pct = parseFloat(document.getElementById('depositPercent').value) || 0;
            const amt = (price * (pct / 100)).toFixed(0);
            // Format output back to field with commas
            document.getElementById('depositAmount').value = new Intl.NumberFormat('en-US').format(amt);
        } else {
            const amt = parseVal('depositAmount');
            if (price > 0) {
                document.getElementById('depositPercent').value = ((amt / price) * 100).toFixed(1);
            }
        }
        calculate();
    }

    function calculate() {
        // 1. Get Values using helper
        const price = parseVal('purchasePrice');
        const capex = parseVal('capex');
        const legal = parseVal('legalCosts');
        const depositAmt = parseVal('depositAmount');
        const rate = parseFloat(document.getElementById('interestRate').value) || 0;
        const years = parseFloat(document.getElementById('loanTerm').value) || 20;
        
        const grossRent = parseVal('rent');
        const rates = parseVal('rates');
        const levies = parseVal('levies');
        const otherCost = parseVal('otherCost');
        
        const vacPct = parseFloat(document.getElementById('vacancy').value) || 0;
        const maintPct = parseFloat(document.getElementById('maintenance').value) || 0;
        const mgmtPct = parseFloat(document.getElementById('management').value) || 0;

        // 2. Acquisition Calculations
        const transferDuty = calculateTransferDuty(price);
        const totalCashRequired = depositAmt + transferDuty + legal + capex;
        const loanAmount = price - depositAmt;

        // 3. Operating Calculations
        const vacancyAmt = grossRent * (vacPct / 100);
        const egi = grossRent - vacancyAmt; // Effective Gross Income
        
        const maintAmt = grossRent * (maintPct / 100);
        const mgmtAmt = grossRent * (mgmtPct / 100);
        
        const totalExpenses = rates + levies + maintAmt + mgmtAmt + otherCost;
        const noi = egi - totalExpenses; // Net Operating Income
        
        const bondPayment = PMT(rate, years, loanAmount);
        const cashflow = noi - bondPayment;

        // 4. Ratios
        const annualizedCashflow = cashflow * 12;
        const annualizedNOI = noi * 12;
        const coc = totalCashRequired > 0 ? (annualizedCashflow / totalCashRequired) * 100 : 0;
        const capRate = price > 0 ? (annualizedNOI / (price + capex + legal + transferDuty)) * 100 : 0;
        const grossYield = price > 0 ? ((grossRent * 12) / price) * 100 : 0;
        const expenseRatio = grossRent > 0 ? ((totalExpenses + vacancyAmt) / grossRent) * 100 : 0;
        const onePercentRule = price > 0 ? (grossRent / (price + capex)) * 100 : 0;

        // 5. Update UI - Hero Cards
        const cfEl = document.getElementById('dispCashflow');
        cfEl.innerText = formatCurrency(cashflow);
        cfEl.className = 'metric-value ' + (cashflow >= 0 ? 'positive' : 'negative');
        document.getElementById('dispCashflowSub').innerText = cashflow >= 0 ? "Passive Income Generated" : "Monthly Shortfall";

        const cocEl = document.getElementById('dispCoC');
        cocEl.innerText = formatPercent(coc);
        cocEl.className = 'metric-value ' + (coc >= 0 ? 'positive' : 'negative');

        document.getElementById('dispCap').innerText = formatPercent(capRate);

        // 6. Update UI - Cash Stack
        document.getElementById('dispDeposit').innerText = formatCurrency(depositAmt);
        document.getElementById('dispTransferDuty').innerText = formatCurrency(transferDuty);
        document.getElementById('dispLegal').innerText = formatCurrency(legal);
        document.getElementById('dispCapex').innerText = formatCurrency(capex);
        document.getElementById('dispTotalCash').innerText = formatCurrency(totalCashRequired);

        // 7. Update UI - Table
        document.getElementById('tblGrossRent').innerText = formatCurrency(grossRent);
        document.getElementById('txtVacancy').innerText = vacPct;
        document.getElementById('tblVacancy').innerText = "-" + formatCurrency(vacancyAmt);
        document.getElementById('tblEGI').innerText = formatCurrency(egi);
        
        document.getElementById('tblRates').innerText = "-" + formatCurrency(rates);
        document.getElementById('tblLevies').innerText = "-" + formatCurrency(levies);
        document.getElementById('txtMgmt').innerText = mgmtPct;
        document.getElementById('tblMgmt').innerText = "-" + formatCurrency(mgmtAmt);
        document.getElementById('txtMaint').innerText = maintPct;
        document.getElementById('tblMaint').innerText = "-" + formatCurrency(maintAmt);
        document.getElementById('tblOther').innerText = "-" + formatCurrency(otherCost);
        
        document.getElementById('tblNOI').innerText = formatCurrency(noi);
        document.getElementById('tblBond').innerText = "-" + formatCurrency(bondPayment);
        
        const tblCfEl = document.getElementById('tblCashflow');
        tblCfEl.innerText = formatCurrency(cashflow);
        tblCfEl.className = 'row-value ' + (cashflow >= 0 ? 'positive' : 'negative');

        // 8. Update UI - Quick Ratios
        document.getElementById('dispExpRatio').innerText = formatPercent(expenseRatio);
        document.getElementById('dispGrossYield').innerText = formatPercent(grossYield);
        document.getElementById('disp1Rule').innerText = onePercentRule >= 1 ? "Yes (" + onePercentRule.toFixed(2) + "%)" : "No (" + onePercentRule.toFixed(2) + "%)";
        document.getElementById('disp1Rule').style.color = onePercentRule >= 1 ? "var(--accent)" : "var(--danger)";

        // 9. Stress Tests
        // Scenario A: Interest Rate + 2%
        const stressRatePayment = PMT(rate + 2, years, loanAmount);
        const stressRateCF = noi - stressRatePayment;
        const sRateEl = document.getElementById('stressRateRes');
        sRateEl.innerText = formatCurrency(stressRateCF);
        sRateEl.className = 'result ' + (stressRateCF >= 0 ? 'positive' : 'negative');

        // Scenario B: High Vacancy (16.66% approx 2 months)
        const stressVacAmt = grossRent * (16.66 / 100);
        const stressEGI = grossRent - stressVacAmt;
        const stressMgmt = (grossRent - stressVacAmt) * (mgmtPct / 100);
        const stressExpenses = rates + levies + maintAmt + stressMgmt + otherCost;
        const stressNOI = stressEGI - stressExpenses;
        const stressVacCF = stressNOI - bondPayment;
        
        const sVacEl = document.getElementById('stressVacRes');
        sVacEl.innerText = formatCurrency(stressVacCF);
        sVacEl.className = 'result ' + (stressVacCF >= 0 ? 'positive' : 'negative');

        // Scenario C: Breakeven Occupancy
        const fixedCosts = rates + levies + otherCost;
        const variableCostRatio = (maintPct + mgmtPct) / 100;
        const requiredNetRent = fixedCosts + bondPayment;
        
        const marginPerRand = grossRent * (1 - variableCostRatio);
        
        let requiredOccupancy = 0;
        if (marginPerRand > 0) {
            requiredOccupancy = (requiredNetRent / marginPerRand) * 100;
        }

        const sBreakEl = document.getElementById('stressBreakRes');
        if (requiredOccupancy > 100) {
            sBreakEl.innerText = "> 100% (Impossible)";
            sBreakEl.className = 'result negative';
        } else {
            sBreakEl.innerText = requiredOccupancy.toFixed(1) + "%";
            sBreakEl.className = 'result ' + (requiredOccupancy > 85 ? 'negative' : 'positive');
        }

        // Break-Even Rent
        const variableRatio = (vacPct + maintPct + mgmtPct) / 100;
        const totalFixed = rates + levies + otherCost + bondPayment;
        let breakEvenRent = 0;
        if (variableRatio < 1) {
            breakEvenRent = totalFixed / (1 - variableRatio);
        } else {
            breakEvenRent = 9999999; 
        }
        document.getElementById('dispBreakEvenRent').innerText = formatCurrency(breakEvenRent);

        // 10. Update Annual Summary
        document.getElementById('sumGrossM').innerText = formatCurrency(grossRent);
        document.getElementById('sumGrossA').innerText = formatCurrency(grossRent * 12);
        
        const totalOutgoingsM = totalExpenses + vacancyAmt;
        document.getElementById('sumExpM').innerText = "-" + formatCurrency(totalOutgoingsM);
        document.getElementById('sumExpA').innerText = "-" + formatCurrency(totalOutgoingsM * 12);
        
        document.getElementById('sumNoiM').innerText = formatCurrency(noi);
        document.getElementById('sumNoiA').innerText = formatCurrency(noi * 12);

        document.getElementById('sumDebtM').innerText = "-" + formatCurrency(bondPayment);
        document.getElementById('sumDebtA').innerText = "-" + formatCurrency(bondPayment * 12);

        document.getElementById('sumFlowM').innerText = formatCurrency(cashflow);
        document.getElementById('sumFlowA').innerText = formatCurrency(cashflow * 12);
        const sumFlowMEl = document.getElementById('sumFlowM');
        const sumFlowAEl = document.getElementById('sumFlowA');
        
        if(cashflow >= 0) {
            sumFlowMEl.classList.add('positive'); sumFlowMEl.classList.remove('negative');
            sumFlowAEl.classList.add('positive'); sumFlowAEl.classList.remove('negative');
        } else {
            sumFlowMEl.classList.add('negative'); sumFlowMEl.classList.remove('positive');
            sumFlowAEl.classList.add('negative'); sumFlowAEl.classList.remove('positive');
        }
    }

    // Initialize
    calculate();
</script>

</body>
</html>
